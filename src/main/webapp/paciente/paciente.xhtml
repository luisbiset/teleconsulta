<ui:composition template="/template/layout.xhtml"
	xmlns="http://www.w3.org/1999/xhtml" xmlns:ui="jakarta.faces.facelets"
	xmlns:h="jakarta.faces.html" xmlns:f="jakarta.faces.core"
	xmlns:p="http://primefaces.org/ui">

	<ui:define name="conteudo">

		<h:form id="formFiltroPaciente">

			<p:growl id="msgs" showDetail="false" life="4000" />

			<div class="topo-pagina">
				<div>
					<h2 class="titulo-pagina">Gerenciamento de Pacientes</h2>
					<span class="subtitulo-pagina">Cadastro, busca e manutenção</span>
				</div>
			</div>

			<div class="barra-filtro">

				<div class="campo-filtro">
					<i class="pi pi-search icone-pesquisa" />

					<p:inputText id="filtroPaciente"
						value="#{pacienteController.filtroPaciente}"
						placeholder="Buscar por Nome ou CPF">

						<p:ajax event="keyup" listener="#{pacienteController.filtrar}"
							update=":formPaciente:tabelaPacientes" />
					</p:inputText>

					<p:commandButton icon="pi pi-times" styleClass="botao-limpar"
						process="@this"
						actionListener="#{pacienteController.limparFiltro}"
						update=":formPaciente:tabelaPacientes"
						onclick="document.getElementById('formFiltroPaciente:filtroPaciente').value='';" />
				</div>

				<p:commandButton value="Novo Paciente" icon="pi pi-plus"
					action="#{pacienteController.novo}" update=":formPaciente:dlg"
					oncomplete="PF('dlgPaciente').show()" />

			</div>
		</h:form>

		<h:form id="formPaciente">

			<p:dataTable id="tabelaPacientes"
				value="#{pacienteController.pacientesFiltrados}" var="p"
				paginator="true" rows="10" paginatorPosition="bottom"
				styleClass="tabela-padrao" rowHover="true"
				emptyMessage="Nenhum registro encontrado.">

				<p:column headerText="Nome">
					<h:outputText value="#{p.usuario.nome}" />
				</p:column>

				<p:column headerText="CPF">
					<h:outputText value="#{p.usuario.cpf}" />
				</p:column>

				<p:column headerText="RG">
					<h:outputText value="#{p.rg}" />
				</p:column>

				<p:column headerText="Telefone">
					<h:outputText value="#{p.telefone}" />
				</p:column>

				<p:column headerText="Data de Nascimento">
					<h:outputText value="#{p.dataNascimento}">
						<f:convertDateTime pattern="dd/MM/yyyy" />
					</h:outputText>
				</p:column>

				<p:column headerText="Ações" style="width:120px; text-align:center;">

					<p:commandButton icon="pi pi-pencil" process="@this"
						update=":formPaciente:dlg"
						action="#{pacienteController.editar(p)}"
						oncomplete="PF('dlgPaciente').show()" />

					<p:commandButton icon="pi pi-trash" process="@this"
						update=":formPaciente:tabelaPacientes :formFiltroPaciente:msgs"
						rendered="#{usuarioController.admin}"
						action="#{pacienteController.excluir(p.id)}">

						<p:confirm header="Confirmação"
							message="Deseja excluir este usuário?"
							icon="pi pi-exclamation-triangle" />
					</p:commandButton>
				</p:column>

			</p:dataTable>

			<p:dialog id="dlg" widgetVar="dlgPaciente"
				header="#{pacienteController.paciente.id == null 
                    ? 'Cadastrar Paciente' 
                    : 'Editar Paciente'}"
				modal="true" closable="true" resizable="false" draggable="false"
				width="480" style="max-height:90vh; overflow:hidden;">
				<h:panelGroup layout="block"
					style="max-height:70vh; overflow-y:auto; padding-right:10px;">
					<h:panelGrid columns="1" cellpadding="6" style="width:100%">

						<h:outputLabel value="Nome:*" />
						<p:inputText value="#{pacienteController.paciente.usuario.nome}"
							required="true" requiredMessage="Nome é obrigatório"
							maxlength="150"
							onkeypress="if (!/[a-zA-ZÀ-ÿ\s]/.test(event.key) || (event.key === ' ' &amp;&amp; this.value.endsWith(' '))) return false;"
							onblur="this.value = this.value.trim().replace(/\s+/g, ' ')" />

						<h:outputLabel value="Nome Social:" />
						<p:inputText value="#{pacienteController.paciente.nomeSocial}"
							maxlength="150"
							onkeypress="if (!/[a-zA-ZÀ-ÿ\s]/.test(event.key) || (event.key === ' ' &amp;&amp; this.value.endsWith(' '))) return false;"
							onblur="this.value = this.value.trim().replace(/\s+/g, ' ')" />

						<h:outputLabel value="Sexo:*" />
						<p:selectOneMenu value="#{pacienteController.paciente.sexo}"
							required="true" requiredMessage="Sexo é obrigatório">
							<f:selectItem itemLabel="Selecione" itemValue="#{null}"
								noSelectionOption="true" />
							<f:selectItem itemLabel="Masculino" itemValue="M" />
							<f:selectItem itemLabel="Feminino" itemValue="F" />
						</p:selectOneMenu>

						<h:outputLabel value="Nome da Mãe:*" />
						<p:inputText value="#{pacienteController.paciente.nomeMae}"
							required="true" requiredMessage="Nome da mãe é obrigatório"
							maxlength="150"
							onkeypress="if (!/[a-zA-ZÀ-ÿ\s]/.test(event.key) || (event.key === ' ' &amp;&amp; this.value.endsWith(' '))) return false;"
							onblur="this.value = this.value.trim().replace(/\s+/g, ' ')" />

						<h:outputLabel value="Nome do Pai:*" />
						<p:inputText value="#{pacienteController.paciente.nomePai}"
							required="true" requiredMessage="Nome do pai é obrigatório"
							onkeypress="if (!/[a-zA-ZÀ-ÿ\s]/.test(event.key) || (event.key === ' ' &amp;&amp; this.value.endsWith(' '))) return false;"
							onblur="this.value = this.value.trim().replace(/\s+/g, ' ')" />

						<h:outputLabel value="Telefone:*" />
						<p:inputMask mask="(99) 99999-9999"
							value="#{pacienteController.paciente.telefone}" required="true"
							converter="telefoneConverter" autoClear="false"
							requiredMessage="Telefone é obrigatório" />

						<h:outputLabel value="CPF:" for="cpf" />
						<p:inputMask id="cpf"
							value="#{pacienteController.paciente.usuario.cpf}"
							mask="999.999.999-99" converter="cpfConverter"
							required="#{pacienteController.paciente.usuario.id == null}"
							requiredMessage="CPF é obrigatório" autoClear="false"
							readonly="#{pacienteController.paciente.usuario.id != null}" />

						<h:outputLabel value="RG:*" />
						<p:inputText value="#{pacienteController.paciente.rg}"
							required="true" requiredMessage="RG é obrigatório" maxlength="10" />

						<h:outputLabel value="CNS:*" />
						<p:inputText value="#{pacienteController.paciente.cns}"
							required="true" requiredMessage="CNS é obrigatório"
							maxlength="15" />

						<h:outputLabel value="Data de Nascimento:*" for="dataNascimento" />
						<p:inputMask value="#{pacienteController.paciente.dataNascimento}"
							mask="99/99/9999" required="true" autoClear="false"
							 converterMessage="Data de nascimento inválida."
							requiredMessage="Data de nascimento é obrigatória">
							<f:convertDateTime pattern="dd/MM/yyyy" />
						</p:inputMask>

						<h:outputLabel value="Email:" />
						<p:inputText value="#{pacienteController.paciente.usuario.email}"
							type="email" />
						<h:outputLabel value="Endereço:*" />
						<p:inputTextarea value="#{pacienteController.paciente.endereco}"
							required="true" requiredMessage="Endereço é obrigatório" rows="2" />

					</h:panelGrid>
				</h:panelGroup>
				<br />
				<p:commandButton value="Salvar"
    action="#{pacienteController.salvar}"
    update=":formPaciente:tabelaPacientes :formFiltroPaciente:msgs"
    process="@form"
    partialSubmit="false"
    oncomplete="if (!args['validationFailed'] &amp;&amp; args.sucesso) PF('dlgPaciente').hide();" />

			</p:dialog>

			<p:confirmDialog global="true" showEffect="fade" hideEffect="fade">
				<p:commandButton value="Sim" type="button"
					styleClass="ui-confirmdialog-yes" icon="pi pi-check" />
				<p:commandButton value="Não" type="button"
					styleClass="ui-confirmdialog-no" icon="pi pi-times" />
			</p:confirmDialog>

		</h:form>

	</ui:define>
</ui:composition>
