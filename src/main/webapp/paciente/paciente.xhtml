<ui:composition template="/template/layout.xhtml"
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:ui="jakarta.faces.facelets"
    xmlns:h="jakarta.faces.html"
    xmlns:f="jakarta.faces.core"
    xmlns:p="http://primefaces.org/ui">

    <ui:define name="conteudo">

        <h:form id="formPaciente">

            <!-- ✅ Somente o Growl (sem h:messages duplicando) -->
            <p:growl id="msgs" showDetail="false" life="4000" />

            <h2>Gerenciamento de Pacientes</h2>

            <!-- BOTÃO NOVO -->
            <p:commandButton value="Novo Paciente"
                             icon="pi pi-plus"
                             action="#{pacienteController.novo}"
                             update=":formPaciente:dlg"
                             oncomplete="PF('dlgPaciente').show()" />

            <br/><br/>

            <!-- TABELA -->
            <p:dataTable value="#{pacienteController.pacientes}"
                         var="p"
                         paginator="true"
                         rows="10"
                         paginatorPosition="bottom">

                <p:column headerText="Nome">
                    <h:outputText value="#{p.nome}"/>
                </p:column>

                <p:column headerText="CPF">
                    <h:outputText value="#{p.cpf}"/>
                </p:column>

                <p:column headerText="Telefone">
                    <h:outputText value="#{p.telefone}"/>
                </p:column>

                <p:column headerText="Ações" style="width:150px; text-align:center;">

                    <p:commandButton icon="pi pi-pencil"
                                     process="@this"
                                     update=":formPaciente:dlg"
                                     action="#{pacienteController.editar(p)}"
                                     oncomplete="PF('dlgPaciente').show()" />

                    <p:commandButton icon="pi pi-trash"
                                     process="@this"
                                     update="@form :formPaciente:msgs"
                                     action="#{pacienteController.excluir(p.id)}"
                                     onclick="return confirm('Deseja excluir este paciente?');"/>
                </p:column>

            </p:dataTable>

            <!-- DIALOG -->
            <p:dialog id="dlg"
                      widgetVar="dlgPaciente"
                      header="Cadastro de Paciente"
                      modal="true"
                      closable="true"
                      resizable="false">

                <h:panelGrid columns="2" cellpadding="5">

                    <h:outputLabel value="Nome:" for="nome"/>
                    <p:inputText id="nome"
                                 value="#{pacienteController.paciente.nome}"
                                 maxlength="150"
                                 onblur="this.value = this.value.trim().replace(/\s+/g, ' ')" />

                    <h:outputLabel value="CPF:" for="cpf"/>
                    <p:inputMask id="cpf"
                                 mask="999.999.999-99"
                                 value="#{pacienteController.paciente.cpf}" />

                    <h:outputLabel value="Telefone:" for="telefone"/>
                    <p:inputMask id="telefone"
                                 mask="(99) 99999-9999"
                                 value="#{pacienteController.paciente.telefone}" />

                    <h:outputLabel value="Data de Nascimento:" for="dataNascimento"/>
                    <p:datePicker id="dataNascimento"
                                  value="#{pacienteController.paciente.dataNascimento}"
                                  pattern="dd/MM/yyyy" />

                </h:panelGrid>

                <br/>

                <!-- ✅ FECHA APENAS SE NÃO HOUVER ERRO -->
                <p:commandButton value="Salvar"
                                 action="#{pacienteController.salvar}"
                                 update="@form :formPaciente:msgs"
                                 oncomplete="if (!args.validationFailed) PF('dlgPaciente').hide();" />

            </p:dialog>

        </h:form>

    </ui:define>

</ui:composition>
